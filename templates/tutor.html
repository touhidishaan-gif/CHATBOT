{% extends "base.html" %}

{% block title %}AI Tutor{% endblock %}

{% block content %}
<div class="page-content fade-in">
    <h2>Chat with Lingo, your Advanced AI Tutor</h2>
    <p>Practice your English conversation skills by choosing a real-life scenario below.</p>
    
    <div class="tutor-container">
        <!-- Scenario Selection -->
        <div id="scenario-selector" class="scenario-selector">
            <button class="scenario-btn" data-scenario="coffee_shop">‚òïÔ∏è Order Coffee</button>
            <button class="scenario-btn" data-scenario="job_interview">ü§ù Job Interview</button>
            <button class="scenario-btn" data-scenario="weekend_trip">üó∫Ô∏è Plan a Trip</button>
            <button id="reset-btn" class="hidden">üîÑ Start a New Scenario</button>
        </div>

        <div class="chat-window" id="chat-window">
            <!-- Messages will be injected here by JavaScript -->
        </div>

        <div class="chat-input-wrapper">
            <div id="chat-input-area" class="chat-input hidden">
                <input type="text" id="user-input" placeholder="Type your response here...">
                <button id="send-btn"><i data-feather="send"></i></button>
            </div>
            <p id="initial-message" class="initial-message">Please select a scenario to begin your practice session.</p>
        </div>
    </div>
    <audio id="audio-player" style="display: none;"></audio>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const chatWindow = document.getElementById('chat-window');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const audioPlayer = document.getElementById('audio-player');
    const scenarioSelector = document.getElementById('scenario-selector');
    const chatInputArea = document.getElementById('chat-input-area');
    const initialMessage = document.getElementById('initial-message');
    const resetBtn = document.getElementById('reset-btn');

    let currentScenario = null;

    // --- Scenario Management ---
    scenarioSelector.addEventListener('click', (e) => {
        const target = e.target.closest('button'); // Handle clicks on icon inside button
        if (target && target.classList.contains('scenario-btn')) {
            currentScenario = target.dataset.scenario;
            startScenario();
        }
        if (target && target.id === 'reset-btn') {
            resetScenario();
        }
    });

    const startScenario = () => {
        chatWindow.innerHTML = '';
        document.querySelectorAll('.scenario-btn').forEach(btn => btn.classList.add('hidden'));
        resetBtn.classList.remove('hidden');
        chatInputArea.classList.remove('hidden');
        initialMessage.classList.add('hidden');
        userInput.focus();
        
        // Get the first message from the bot for this scenario
        sendMessageToServer('', currentScenario); 
    };
    
    const resetScenario = () => {
        currentScenario = null;
        chatWindow.innerHTML = '';
        document.querySelectorAll('.scenario-btn').forEach(btn => btn.classList.remove('hidden'));
        resetBtn.classList.add('hidden');
        chatInputArea.classList.add('hidden');
        initialMessage.classList.remove('hidden');
    };

    // --- Message Handling ---
    const sendMessage = async () => {
        const message = userInput.value.trim();
        if (!message) return;
        
        appendMessage(message, 'user');
        userInput.value = '';
        await sendMessageToServer(message, currentScenario);
    };

    const sendMessageToServer = async (message, scenario) => {
        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message, scenario: scenario })
            });
            if (!response.ok) throw new Error('Network response was not ok.');
            
            const data = await response.json();
            appendMessage(data.reply, 'tutor');

        } catch (error) {
            appendMessage('Sorry, an error occurred. Please try again.', 'tutor');
            console.error('Error:', error);
        }
    };

    const appendMessage = (text, sender) => {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('chat-bubble', sender);
        
        const messageP = document.createElement('p');
        messageP.innerText = text;
        messageDiv.appendChild(messageP);

        if (sender === 'tutor') {
            const ttsBtn = document.createElement('button');
            ttsBtn.classList.add('tts-btn');
            ttsBtn.innerHTML = '<i data-feather="volume-2"></i>';
            ttsBtn.onclick = () => handleTTS(text);
            messageDiv.appendChild(ttsBtn);
        }
        
        chatWindow.appendChild(messageDiv);
        feather.replace();
        chatWindow.scrollTop = chatWindow.scrollHeight; // Auto-scroll
    };

    // --- Event Listeners ---
    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    // --- Text-to-Speech ---
    const handleTTS = async (text) => {
        try {
            const response = await fetch('/api/tts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: text })
            });
            if (!response.ok) throw new Error('Failed to generate audio.');

            const audioBlob = await response.blob();
            const audioUrl = URL.createObjectURL(audioBlob);
            audioPlayer.src = audioUrl;
            audioPlayer.play();
        } catch (error) {
            console.error('TTS Error:', error);
        }
    };
});
</script>
{% endblock %}

