{% extends "base.html" %}

{% block title %}Grammar & Vocab Checker{% endblock %}

{% block content %}
<div class="page-content fade-in">
    <h2>Check Grammar & Improve Vocabulary</h2>
    <p>Write your text below, and our AI will help you improve it.</p>
    
    <div class="checker-container">
        <textarea id="text-input" placeholder="Start typing here..."></textarea>
        <div class="controls">
            <button id="grammar-btn"><i data-feather="check-circle"></i> Correct Grammar</button>
            <button id="vocab-btn"><i data-feather="star"></i> Improve Vocabulary</button>
        </div>
        
        <div id="result-container" class="hidden">
            <h3>AI Suggestion:</h3>
            <div id="loading" class="hidden">
                <div class="spinner"></div>
            </div>
            <div id="result-text-wrapper">
                <p id="result-text"></p>
                <button id="listen-btn" title="Listen to text"><i data-feather="volume-2"></i></button>
            </div>
        </div>
        <audio id="audio-player" style="display: none;"></audio>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const grammarBtn = document.getElementById('grammar-btn');
    const vocabBtn = document.getElementById('vocab-btn');
    const listenBtn = document.getElementById('listen-btn');
    const textInput = document.getElementById('text-input');
    const resultContainer = document.getElementById('result-container');
    const resultText = document.getElementById('result-text');
    const loadingSpinner = document.getElementById('loading');
    const audioPlayer = document.getElementById('audio-player');

    const handleRequest = async (action) => {
        const text = textInput.value.trim();
        if (!text) {
            alert('Please enter some text.');
            return;
        }

        resultContainer.classList.remove('hidden');
        loadingSpinner.classList.remove('hidden');
        resultText.textContent = '';
        listenBtn.classList.add('hidden');

        try {
            const response = await fetch('/api/process', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text, action })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Something went wrong.');
            }

            const data = await response.json();
            resultText.textContent = data.result;
            listenBtn.classList.remove('hidden');

        } catch (error) {
            resultText.textContent = 'Error: ' + error.message;
        } finally {
            loadingSpinner.classList.add('hidden');
        }
    };

    const handleTTS = async () => {
        const text = resultText.textContent;
        if (!text) return;
        
        listenBtn.disabled = true;

        try {
            const response = await fetch('/api/tts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: text })
            });
            if (!response.ok) throw new Error('Failed to generate audio.');

            const audioBlob = await response.blob();
            const audioUrl = URL.createObjectURL(audioBlob);
            audioPlayer.src = audioUrl;
            audioPlayer.play();
        } catch (error) {
            alert('Error generating audio: ' + error.message);
        } finally {
            listenBtn.disabled = false;
        }
    };

    grammarBtn.addEventListener('click', () => handleRequest('grammar'));
    vocabBtn.addEventListener('click', () => handleRequest('vocabulary'));
    listenBtn.addEventListener('click', handleTTS);
});
</script>
{% endblock %}
